<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>श्री महावीराय नमः</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
</head>
<body class="bg-[#FDFDFD] font-['Inter'] text-gray-900 antialiased">
  <header class="bg-[#5A204A] text-white shadow-lg sticky top-0 z-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="logo2.png" alt="Jain Logo" class="h-10 w-auto ">
             <a href="index.html" class="text-white hover:text-gray-300"><h1 class="text-2xl font-semibold">श्री महावीराय नमः</h1></a> 
       
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Summary Stats -->
    <div class="mb-8 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
      <div class="bg-white rounded-lg p-4 shadow-sm text-center">
        <div class="text-2xl font-bold text-[#5A204A]" id="totalCount">0</div>
        <div class="text-sm text-gray-600">Total Records</div>
      </div>
      <div class="bg-white rounded-lg p-4 shadow-sm text-center">
        <div class="text-2xl font-bold text-[#5A204A]" id="pendingCount">0</div>
        <div class="text-sm text-gray-600">Pending Count</div>
      </div>
      <div class="bg-white rounded-lg p-4 shadow-sm text-center">
        <div class="text-2xl font-bold text-[#5A204A]" id="completedCount">0</div>
        <div class="text-sm text-gray-600">Completed Count</div>
      </div>
      <div class="bg-white rounded-lg p-4 shadow-sm text-center">
        <div class="text-2xl font-bold text-[#5A204A]" id="totalAmount">₹0.00</div>
        <div class="text-sm text-gray-600">Total Amount</div>
      </div>
      <div class="bg-white rounded-lg p-4 shadow-sm text-center">
        <div class="text-2xl font-bold text-[#5A204A]" id="completedAmount">₹0.00</div>
        <div class="text-sm text-gray-600">Completed Amount</div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <section class="bg-white rounded-xl shadow-md p-6 lg:col-span-1">
      <h2 class="text-xl font-semibold text-gray-800 mb-6">Add / Edit Donation</h2>
      <form id="donationForm" class="space-y-5">
        <input type="hidden" id="editingId" />
        <div>
          <label for="donor" class="block text-sm font-medium text-gray-700">Donor Name</label>
          <input id="donor" placeholder="e.g., Ramesh Kumar" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#5A204A] transition" />
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="amount" class="block text-sm font-medium text-gray-700">Amount (INR)</label>
            <input id="amount" type="number" min="0" step="0.01" placeholder="e.g., 500.00" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#5A204A] transition" />
          </div>
          <div>
            <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
            <input id="date" type="date" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#5A204A] transition" />
          </div>
        </div>
        <div>
          <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
          <select id="status" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#5A204A] transition">
            <option value="pending">Pending</option>
            <option value="completed">Completed</option>
          </select>
        </div>
        <div>
          <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
          <textarea id="notes" rows="4" placeholder="Optional note or purpose" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#5A204A] transition"></textarea>
        </div>
        <div class="flex gap-4">
          <button type="submit" id="saveBtn" class="w-full sm:w-auto px-6 py-3 bg-[#5A204A] text-white rounded-lg hover:bg-[#4A1A3D] transition">Save Donation</button>
          <button type="button" id="resetBtn" class="w-full sm:w-auto px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Reset</button>
        </div>
        <p class="text-xs text-gray-500">Data is now managed by the backend server.</p>
      </form>
    </section>

      <section class="bg-white rounded-xl shadow-md p-6 lg:col-span-2">
      <h2 class="text-xl font-semibold text-gray-800 mb-6">Donations</h2>

      <!-- Moved Controls -->
      <div class="mb-6 flex flex-col sm:flex-row gap-4 items-center justify-between flex-wrap">
        <div class="flex flex-col sm:flex-row gap-3 items-center w-full sm:w-auto">
          <input id="search" type="search" placeholder="Search donor or notes..." class="w-full sm:w-64 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#5A204A] bg-white text-gray-900 transition" />
          <select id="filterStatus" class="w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#5A204A] bg-white text-gray-900">
            <option value="all">All Statuses</option>
            <option value="completed">Completed</option>
            <option value="pending">Pending</option>
          </select>
        </div>
        <div class="flex gap-3 flex-wrap">
          <button id="exportCsv" class="w-full sm:w-auto px-4 py-2 bg-[#5A204A] text-white rounded-lg hover:bg-[#4A1A3D] transition">Export CSV</button>
          <button id="backupJson" class="w-full sm:w-auto px-4 py-2 bg-[#5A204A] text-white rounded-lg hover:bg-[#4A1A3D] transition">Backup JSON</button>
          <button id="clearAll" class="w-full sm:w-auto px-4 py-2 bg-[#5A204A] text-white rounded-lg hover:bg-[#4A1A3D] transition">Clear All</button>
        </div>
      </div>

      <div class="overflow-x-auto border border-gray-200 rounded-lg">
        <table class="w-full table-auto">
          <thead>
            <tr class="text-sm text-gray-600">
              <th class="py-4 px-4 text-left font-medium">Donor</th>
              <th class="py-4 px-4 text-left font-medium">Amount</th>
              <th class="py-4 px-4 text-left font-medium">Date</th>
              <th class="py-4 px-4 text-left font-medium">Status</th>
              <th class="py-4 px-4 text-left font-medium">Notes</th>
              <th class="py-4 px-4 text-left font-medium">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div id="empty" class="hidden text-center py-8 text-gray-500 bg-white">No donations yet. Add the first one.</div>
      </div>
    </section>
    </div>
  </main>

  <script>
    // Utility
    
    function formatCurrency(n) {
      const amount = Number(n || 0);
      return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 2 }).format(amount);
    }

    // Elements
    const form = document.getElementById('donationForm');
    const donor = document.getElementById('donor');
    const amount = document.getElementById('amount');
    const dateEl = document.getElementById('date');
    const statusEl = document.getElementById('status');
    const notes = document.getElementById('notes');
    const editingId = document.getElementById('editingId');
    const tbody = document.getElementById('tbody');
    const empty = document.getElementById('empty');
    const totalCount = document.getElementById('totalCount');
    const pendingCount = document.getElementById('pendingCount');
    const completedCount = document.getElementById('completedCount');
    const totalAmount = document.getElementById('totalAmount');
    const completedAmount = document.getElementById('completedAmount');
    const search = document.getElementById('search');
    const filterSel = document.getElementById('filterStatus');
    const exportBtn = document.getElementById('exportCsv');
    const backupBtn = document.getElementById('backupJson');
    const clearBtn = document.getElementById('clearAll');
    const resetBtn = document.getElementById('resetBtn');

    let donations = [];
    let filterStatus = 'all';
    let searchText = '';

    // Initialize defaults
    dateEl.valueAsDate = new Date();

    // Fetch and Render
    function getAuthHeaders() {
      const token = localStorage.getItem('token');
      if (token) {
        return { 'Authorization': `Bearer ${token}` };
      }
      return {};
    }

    async function fetchDonations() {
      try {
        const response = await fetch('https://temple-4bpo.onrender.com/api/donations/admin', {
          headers: getAuthHeaders()
        });
        if (!response.ok) {
          if (response.status === 401 || response.status === 403) {
            alert('Session expired or unauthorized. Please log in again.');
            window.location.href = '/login.html'; // Redirect to login page
            return;
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        donations = await response.json();
        render();
      } catch (error) {
        console.error('Error fetching donations:', error);
        alert('Failed to fetch donations. Please check console for details.');
      }
    }

    function render() {
      const q = searchText.trim().toLowerCase();
      const view = donations.filter(d => {
        const okStatus = filterStatus === 'all' ? true : d.status === filterStatus;
        const okSearch = !q ? true : (d.donor.toLowerCase().includes(q) || (d.notes || '').toLowerCase().includes(q));
        return okStatus && okSearch;
      });

      // Stats
      totalCount.textContent = donations.length;
      pendingCount.textContent = donations.filter(d => d.status === 'pending').length;
      completedCount.textContent = donations.filter(d => d.status === 'completed').length;
      totalAmount.textContent = formatCurrency(donations.reduce((s, d) => s + Number(d.amount || 0), 0));
      completedAmount.textContent = formatCurrency(donations.filter(d => d.status === 'completed').reduce((s, d) => s + Number(d.amount || 0), 0));

      // Rows
      tbody.innerHTML = '';
      if (view.length === 0) {
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');
      for (const d of view) {
        const tr = document.createElement('tr');
        tr.className = 'border-t border-gray-200 hover:bg-gray-50 transition';
        tr.innerHTML = `
          <td class="py-4 px-4 font-medium">${escapeHtml(d.donor)}</td>
          <td class="py-4 px-4">${formatCurrency(d.amount)}</td>
          <td class="py-4 px-4">${escapeHtml(new Date(d.date).toISOString().split('T')[0])}</td>
          <td class="py-4 px-4">
            <span class="inline-block px-3 py-1 text-xs font-medium rounded-full ${d.status === 'completed' ? 'bg-[#D4AF37] text-[#5A204A]' : 'bg-[#F0E68C] text-[#5A204A]'}">
              ${d.status.charAt(0).toUpperCase() + d.status.slice(1)}
            </span>
          </td>
          <td class="py-4 px-4">${escapeHtml(d.notes || '')}</td>
          <td class="py-4 px-4 flex gap-2">
            <button class="px-4 py-1 bg-[#D4AF37] text-[#5A204A] rounded-lg hover:bg-[#F0E68C] transition" data-edit="${d._id}">Edit</button>
            <button class="px-4 py-1 bg-[#F0E68C] text-[#5A204A] rounded-lg hover:bg-[#D4AF37] transition" data-del="${d._id}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    function escapeHtml(s) {
      return String(s).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
    }

    // Handlers
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        donor: donor.value.trim(),
        amount: Number(amount.value),
        date: dateEl.value,
        status: statusEl.value,
        notes: notes.value.trim()
      };
      if (!data.donor || !isFinite(data.amount) || data.amount < 0 || !data.date) {
        alert('Please fill a valid donor, amount, and date.');
        return;
      }

      const id = editingId.value;
      try {
        if (id) {
          await fetch(`https://temple-4bpo.onrender.com/api/donations/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
            body: JSON.stringify(data)
          });
        } else {
          await fetch('https://temple-4bpo.onrender.com/api/donations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
            body: JSON.stringify(data)
          });
        }
        resetForm();
        fetchDonations();
      } catch (error) {
        console.error('Error saving donation:', error);
        alert('Failed to save donation.');
      }
    });

    function resetForm() {
      form.reset();
      editingId.value = '';
      dateEl.valueAsDate = new Date();
      statusEl.value = 'pending';
    }
    resetBtn.addEventListener('click', resetForm);

    tbody.addEventListener('click', async (e) => {
      const t = e.target;
      if (t.dataset.edit) {
        const d = donations.find(x => x._id === t.dataset.edit);
        if (!d) return;
        editingId.value = d._id;
        donor.value = d.donor;
        amount.value = d.amount;
        dateEl.value = new Date(d.date).toISOString().split('T')[0]; // Format date for input
        statusEl.value = d.status;
        notes.value = d.notes || '';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      if (t.dataset.del) {
        const id = t.dataset.del;
        if (confirm('Delete this donation?')) {
          try {
            await fetch(`https://temple-4bpo.onrender.com/api/donations/${id}`, { method: 'DELETE', headers: getAuthHeaders() });
            fetchDonations();
          } catch (error) {
            console.error('Error deleting donation:', error);
            alert('Failed to delete donation.');
          }
        }
      }
    });

    search.addEventListener('input', () => { searchText = search.value; render(); });
    filterSel.addEventListener('change', () => { filterStatus = filterSel.value; render(); });

    // Export CSV (client-side for now, can be moved to backend if data size is large)
    function toCsv(rows) {
      if (!rows.length) return '';
      const headers = ['_id', 'donor', 'amount', 'date', 'status', 'notes'];
      const esc = v => `"${String(v ?? '').replace(/"/g, '""')}"`;
      const lines = [headers.join(',')];
      for (const r of rows) {
        lines.push(headers.map(h => esc(r[h])).join(','));
      }
      return lines.join('\n');
    }
    function download(filename, content, mime = 'text/plain;charset=utf-8') {
      const blob = new Blob([content], { type: mime });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(a.href), 1000);
    }
    exportBtn.addEventListener('click', () => {
      if (!donations.length) { alert('No data to export'); return; }
      const csv = toCsv(donations);
      download('temple-donations.csv', csv, 'text/csv;charset=utf-8');
    });

    // Backup / Restore (client-side for now)
    backupBtn.addEventListener('click', () => {
      download('temple-donations-backup.json', JSON.stringify(donations, null, 2), 'application/json');
    });

    clearBtn.addEventListener('click', async () => {
      if (confirm('This will remove all donation records. Proceed?')) {
        try {
          await fetch('https://temple-4bpo.onrender.com/api/donations/clear', { method: 'POST' }); // New endpoint for clearing all
          fetchDonations();
        } catch (error) {
          console.error('Error clearing all donations:', error);
          alert('Failed to clear all donations.');
        }
      }
    });

    // Initial fetch
    fetchDonations();
  </script>
</body>
</html>